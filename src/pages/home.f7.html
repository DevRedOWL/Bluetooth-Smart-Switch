<template>
  <div class="page" data-name="home">
    <div class="navbar">
      <div class="navbar-bg"></div>
      <div class="navbar-inner sliding">
        <div class="title">Bluetooth lock</div>
      </div>
    </div>

    <!-- Scrollable page content-->
    <div class="page-content">

      <div class="block padlock-parent">
        <div id="padlock" class="padlock">
          <div class="keyhole"></div>
        </div>
      </div>

      <!-- <div class="block">
        <a href="" class="button button-fill button-round" style="width: 70%; margin: 0 auto;"
          @click="${ConnectAndSend}">Click</a>
      </div> -->

    </div>
  </div>
</template>
<script>
  // Includes
  import SettingsModel from '../js/models/settingsModel.js';
  import debugToast from '../js/debugToaster.js';

  export default (props, { $f7, $, $on }) => {
    // Ux elements
    let padlock;
    function openKeyPadlock() {
      tryVibrate(8);
      padlock.classList.add('keyunlock');
    };
    function openPadlock() {
      new Audio('./static/IphoneLock.mp3').play();
      padlock.classList.add('unlock');
    };
    function closePadlock() {
      padlock.classList.remove('unlock');
      padlock.classList.remove('keyunlock');
    };
    function shakePadlock() {
      tryVibrate(140);
      padlock.classList.remove('unlock');
      padlock.classList.remove('keyunlock');
      padlock.classList.add('shake');
      setTimeout(() => padlock.classList.remove('shake'), 820);
    }
    // Notificatior
    function notificatie(icon, title, subtitle, text) {
      $f7.notification.create({
        icon: `<i class="f7-icons icon">${icon}</i>`,
        title: title,
        titleRightText: 'now',
        subtitle: subtitle,
        text: text,
        closeTimeout: 2000,
      }).open();
    }

    // String to array buf
    function stringToBytes(string) {
      var array = new Uint8Array(string.length);
      for (var i = 0, l = string.length; i < l; i++) {
        array[i] = string.charCodeAt(i);
      }
      return array.buffer;
    }

    // cordova-plugin-vibrate
    function tryVibrate(time) {
      try { navigator.vibrate(time); return true; }
      catch (error) { return false; }
    }

    // Set variables when page ready
    $(document).on('page:init', '.page[data-name="home"]', function (e) {
      // [!] Интересное замечание - даже если в закоменченном куске html кода есть несуществующая функция - не соберется
      padlock = $('#padlock')[0];
      //padlock.addEventListener('click', () => padlock.classList.contains('unlock') ? closePadlock() : openPadlock());
      $('#padlock').on('click', () => ConnectAndSend());
      // DEBUG
      // $('#padlock').on('taphold', () => { openKeyPadlock(); setTimeout(() => openPadlock(), 300); setTimeout(() => closePadlock(), 1000); });
    })

    // Send a request
    function ConnectAndSend(
      deviceUUID = SettingsModel.get().deviceUUID,
      authCode = SettingsModel.get().authCode,
      serviceUUID = SettingsModel.get().deviceServiceUUID,
      characteristicUUID = SettingsModel.get().deviceCharacteristicUUID) {
      openKeyPadlock();
      // Trying to connect to a device
      try {
        ble.connect(deviceUUID,
          // On connect success
          (connectData) => {
            console.log('Device connected');
            ble.writeWithoutResponse(
              // Request data
              deviceUUID,
              serviceUUID, // service_uuid (FFE0)
              characteristicUUID, // characteristic_uuid (FFE1)
              stringToBytes(authCode), // new Uint8Array([0xFF, 0xFF]).buffer;
              // On write success callback
              () => {
                try {
                  // Open animation and close it soon, if data succesfully written
                  openPadlock();
                  setTimeout(closePadlock, 2500);
                  console.log('Code sent');
                } catch (error) {
                  console.log(error.message, error.trace);
                  shakePadlock();
                }
                // Disconnect
                setTimeout(() => ble.disconnect(deviceUUID), 2000);
              },
              // On write error disconnect
              () => {
                notificatie('wifi_slash', 'Error', `Device disconnected`);
                shakePadlock(); // Disconnect animation            
                setTimeout(() => ble.disconnect(deviceUUID), 2000); // Отключаемся от устройства
              });
          },
          // On device disconnected or error
          () => {
            notificatie('wifi_slash', 'Error', `Device is not available`);
            shakePadlock();
          });
      }
      catch (error) {
        shakePadlock();
        notificatie('device_laptop', 'Error', error, `It seems that this device doesn't support Bluetooth LE`);
      }
    }
    return $render;
  }
</script>