<template>
  <div class="page" data-name="home">
    <div class="navbar">
      <div class="navbar-bg"></div>
      <div class="navbar-inner sliding">
        <div class="title">Bluetooth ${L('LOCK')}</div>
      </div>
    </div>

    <!-- Scrollable page content-->
    <div class="page-content">

      <div class="block padlock-parent">
        <div id="padlock" class="padlock" @click="${ConnectAndSend}">
          <div class="keyhole"></div>
        </div>
      </div>

      <!-- <div class="block">
        <a href="" class="button button-fill button-round" style="width: 70%; margin: 0 auto;"
          @click="${ConnectAndSend}">Click</a>
      </div> -->

    </div>
  </div>
</template>
<script>
  // Includes
  import SettingsModel from '../js/models/settingsModel.js';
  import { tapKeyVibrate, shakeVibrate } from '../js/vibrate.js'

  export default (props, { $store, $f7, $, $on }) => {
    // Locales
    const Locales = $store.getters.locales;
    const L = (id) => Locales.value[id] ? Locales.value[id] : `$${id}`;

    // Ux elements
    let padlock;
    function openKeyPadlock() {
      tapKeyVibrate();
      padlock.classList.add('keyunlock');
    };
    function openPadlock() {
      new Audio('./static/IphoneLock.mp3').play();
      padlock.classList.add('unlock');
    };
    function closePadlock() {
      padlock.classList.remove('unlock');
      padlock.classList.remove('keyunlock');
    };
    function shakePadlock() {
      shakeVibrate();
      padlock.classList.remove('unlock');
      padlock.classList.remove('keyunlock');
      padlock.classList.add('shake');
      setTimeout(() => padlock.classList.remove('shake'), 820);
    };
    // Notificatior
    function notificatie(icon, title, subtitle, text) {
      $f7.notification.create({
        icon: `<i class="f7-icons icon">${icon}</i>`,
        title: title,
        titleRightText: 'now',
        subtitle: subtitle,
        text: text,
        closeTimeout: 2000,
      }).open();
    }

    // String to array buf
    function stringToBytes(string) {
      var array = new Uint8Array(string.length);
      for (var i = 0, l = string.length; i < l; i++) {
        array[i] = string.charCodeAt(i);
      }
      return array.buffer;
    }

    // Set variables when page ready
    $(document).on('page:init', '.page[data-name="home"]', function (e) {
      // [!] Интересное замечание - даже если в закоменченном куске html кода есть несуществующая функция - не соберется
      padlock = $('#padlock')[0];

      window._1 = openKeyPadlock; window._2 = openPadlock; window._3 = closePadlock;
    });
    // $('#padlock').on('taphold', () => { openKeyPadlock(); setTimeout(() => openPadlock(), 300); setTimeout(() => closePadlock(), 1000); });


    // Send a request
    function ConnectAndSend(
      deviceUUID = SettingsModel.get().deviceUUID,
      accessCode = SettingsModel.get().accessCode,
      serviceUUID = SettingsModel.get().deviceServiceUUID,
      characteristicUUID = SettingsModel.get().deviceCharacteristicUUID) {
      openKeyPadlock();
      // Connect to device in 200ms to proper aniation cycle
      setTimeout(() => {
        // Trying to connect to a device
        try {
          ble.connect(deviceUUID,
            // On connect success
            (connectData) => {
              console.log('Device connected');
              ble.writeWithoutResponse(
                // Request data
                deviceUUID,
                serviceUUID,
                characteristicUUID,
                stringToBytes(accessCode),
                // On write success callback
                () => {
                  try {
                    // Open animation and close it soon, if data succesfully written
                    openPadlock();
                    setTimeout(closePadlock, 2500);
                    console.log('Code sent');
                  } catch (error) {
                    console.log(error.message, error.trace);
                    shakePadlock();
                  }
                  // Disconnect
                  setTimeout(() => ble.disconnect(deviceUUID), 2000);
                },
                // On write error disconnect
                () => {
                  notificatie('wifi_slash', L('ERROR'), L('CONNECTION_ERROR'));
                  shakePadlock(); // Disconnect animation            
                  setTimeout(() => ble.disconnect(deviceUUID), 2000); // Отключаемся от устройства
                });
            },
            // On device disconnected or error
            () => {
              notificatie('wifi_exclamationmark', L('ERROR'), L('DEVICE_NA'));
              shakePadlock();
            });
        }
        catch (error) {
          shakePadlock();
          notificatie('device_laptop', L('ERROR'), error, L('BLE_ERROR'));
        }
      }, 250);
    }
    return $render;
  }
</script>