<template>
    <div class="page" data-name="settings">
        <div class="page-content">
            <!-- Select device -->
            <div class="block" style="padding: 0 20px;">
                <div class="block-title" style=" font-size: 25px; height: 28px; margin: 20px 0 0 5px;">
                    <div style="display: inline-block;">Device settings</div>
                </div>
                <div class="img_w_bg" @click="${openDevicesSheet}"
                    style="background-image: url(./static/deviceBG.jpeg); background-position: bottom; margin-top: 10px;">
                    <div class="img_darker">
                        <div style="font-size: 20px;">${settings.value.deviceSSID}</div>
                        <div style="font-size: 10px;">${settings.value.deviceUUID}
                            <span
                                style="padding-left: 4px;">[${settings.value.deviceServiceUUID}/${settings.value.deviceCharacteristicUUID}]</span>
                        </div>
                        <div style="opacity: 0.7;">
                            <a style="color: white;" href="#view-settings" class="tab-link"> Select device</a>
                        </div>
                    </div>
                </div>
                <!-- Other settings -->
                <div class="block-title" style="font-size: 25px; height: 28px; margin: 20px 0 0 5px;">
                    Custom
                </div>
                <div id="custom-settings">
                    <div class="img_no_bg" @click="${switchDarkMode}">
                        <div class="bg_darker">
                            <div class="tt-icon">
                                <i class="icon f7-icons" style="background-image: url('../static/icons/bar.png');">
                                    ${settings.value.darkMode ? 'sun_min' : 'moon'}
                                </i>
                            </div>
                            <div class="tt-content">
                                <div class="tt-title">${settings.value.darkMode ? 'Light' : 'Dark'} mode</div>
                                <div class="tt-subtitle">${settings.value.darkMode ? 'Dark' : 'Light'} mode enabled
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="img_no_bg" @click="${setaccessCode}">
                        <div class="bg_darker">
                            <div class="tt-icon">
                                <i class="icon f7-icons"
                                    style="background-image: url('../static/icons/bar.png');">lock</i>
                            </div>
                            <div class="tt-content">
                                <div class="tt-title">Access code</div>
                                <div class="tt-subtitle" style="width: 80%; overflow: hidden;">
                                    ${settings.value.accessCode.replace(/./g, 'â€¢')}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="img_no_bg" @click="${setDeviceTag}">
                        <div class="bg_darker">
                            <div class="tt-icon">
                                <i class="icon f7-icons">tag</i>
                            </div>
                            <div class="tt-content">
                                <div class="tt-title">Device tag</div>
                                <div class="tt-subtitle">
                                    ${settings.value.deviceTag}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="img_no_bg" @click="${switchLanguage}">
                        <div class="bg_darker">
                            <div class="tt-icon">
                                <i class="icon f7-icons">textformat_abc</i>
                            </div>
                            <div class="tt-content">
                                <div class="tt-title">Language</div>
                                <div class="tt-subtitle">
                                    ${settings.value.appLanguage}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Modals -->
        <div class="sheet-modal search-devices-sheet" style="height:70vh; border-radius: 15px 15px 0 0;">
            <div class="swipe-handler can_swipe_down" style="height: 50px"></div>
            <div class="sheet-modal-inner">
                <div class="sheet-modal-swipe-step can_swipe_down">
                    <div class="padding">
                        <div>
                            <div class="display-flex justify-content-space-between align-items-center">
                                <div style="font-size: 18px;"><b>Device:</b></div>
                                <div class="accent-text settings-modal-right-text">${settings.value.deviceSSID}</div>
                            </div>
                        </div>
                        <div>
                            <div class="display-flex justify-content-space-between align-items-center">
                                <div style="font-size: 18px;"><b>UUID:</b></div>
                                <div class="accent-text settings-modal-right-text">${settings.value.deviceUUID}</div>
                            </div>
                        </div>
                        <div>
                            <div class="display-flex justify-content-space-between align-items-center">
                                <div style="font-size: 18px;"><b>Service:</b></div>
                                <div class="accent-text settings-modal-right-text">${settings.value.deviceServiceUUID}
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="display-flex justify-content-space-between align-items-center">
                                <div style="font-size: 18px;"><b>Characteristic:</b></div>
                                <div class="accent-text settings-modal-right-text">
                                    ${settings.value.deviceCharacteristicUUID}</div>
                            </div>
                        </div>
                    </div>
                    <div class="padding-horizontal padding-bottom">
                        <a class="button button-large button-fill" id="searchBtn" @click="${searchDevices}">
                            ${scanState.value ? 'Stop search' : 'Search'}
                        </a>
                        <div class="margin-top text-align-center">Swipe up for device list</div>
                    </div>
                </div>
                <div class="block-title block-title-medium margin-top">Select device:</div>
                <div class="list no-hairlines" style="height: calc(70vh - 332px); overflow-y: scroll;">
                    <ul>
                        ${
                        btDevices.value.length ?
                        btDevices.value.map((device) => $h`
                        <li class="item-content" @click=${selectDevice.bind(device)}>
                            <div class="item-inner">
                                <div class="item-after text-color-black" style="margin-left: 0; padding-left: 0;">
                                    <b>${device.ssid}</b>
                                </div>
                                <div class="item-title" style="font-size: 12px; padding-left: 10px; margin-top: 2px;">
                                    ${device.uuid}
                                </div>
                            </div>
                        </li>
                        `)
                        : [1,2,3,4,5,6].map((item)=>$h`
                        <li class="item-content skeleton-text skeleton-effect-wave">
                            <div class="item-inner">
                                <div class="item-after text-color-black" style="margin-left: 0; padding-left: 0;">
                                    <b>UndefinedName</b>
                                </div>
                                <div class="item-title" style="font-size: 12px; padding-left: 10px; margin-top: 2px;">
                                    00:00:00:00:00:00:00:00:00:00
                                </div>
                            </div>
                        </li>
                        `)
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>
</template>
<script>
    import debugToast from '../js/debugToaster.js';
    import {
        tapVibrate,
        shakeVibrate
    } from '../js/vibrate.js'

    export default (props, {
        $f7,
        $,
        $store
    }) => {
        // State management via store object
        const settings = $store.getters.settings;
        const btDevices = $store.getters.btDevices;
        const scanState = $store.getters.scanState;
        // State encapsulation
        const updateSettings = (propName, propValue) => {
            $store.dispatch('updateSettings', {
                propName,
                propValue
            });
        }
        const addDevice = (ssid, uuid) => {
            $store.dispatch('addBTDevice', {
                ssid,
                uuid
            });
        }
        const clearDevices = (ssid, uuid) => {
            $store.dispatch('clearBTDevices');
        }
        const setScanState = (newState) => {
            $store.dispatch('setScanState', newState);
        }

        // UX
        function shakeSearchBtn() {
            shakeVibrate();
            searchBtn.classList.add('shake');
            setTimeout(() => searchBtn.classList.remove('shake'), 820);
        }

        // Dark mode
        function switchDarkMode() {
            tapVibrate();
            updateSettings('darkMode', settings.value.darkMode ? false : true);
            notificatie(
                settings.value.darkMode ? 'moon' : 'sun_min',
                'Settings',
                `${settings.value.darkMode ? 'Dark' : 'Light'} mode enabled`
            );
        }

        // Access code
        function setaccessCode() {
            tapVibrate();
            $f7.dialog.password('Enter new access code',
                function (accessCode) {
                    if (accessCode.length > 255) {
                        return notificatie('pencil_ellipsis_rectangle', 'Error', 'Access code can not be large, than 255 symbols');
                    }
                    tapVibrate();
                    updateSettings('accessCode', accessCode);
                    notificatie('lock', 'Settings', 'Access code updated');
                });
        }

        // Device tag
        function setDeviceTag() {
            tapVibrate();
            $f7.dialog.prompt('Enter new device tag',
                function (deviceTag) {
                    if (deviceTag.length > 16) {
                        return notificatie('pencil_ellipsis_rectangle', 'Error', 'Device tag can not be large, than 16 symbols');
                    }
                    tapVibrate();
                    updateSettings('deviceTag', deviceTag);
                    notificatie('tag', 'Settings', 'Device tag updated');
                });
        }

        function switchLanguage() {
            tapVibrate();
            updateSettings('appLanguage', settings.value.appLanguage == 'en' ? 'ru' : 'en');
            notificatie('textformat', 'Settings', 'Application language updated');
        }

        // Search devies
        function openDevicesSheet() {
            tapVibrate();
            sheet.open();
        }

        function selectDevice(data) {
            $f7.dialog.confirm(`Select device ${this.ssid} with UUID ${this.uuid}?`,
                () => {
                    tapVibrate();
                    notificatie('dot_radiowaves_left_right', 'Settings', 'Device selected');
                    sheet.close();
                    updateSettings('deviceSSID', this.ssid);
                    updateSettings('deviceUUID', this.uuid);
                });
        }

        function scanForDevices() {
            clearDevices();
            sheet.stepOpen();
            ble.startScan([],
                // On scan successful
                function (device) {
                    addDevice(device.name ? device.name : 'Undefined', device.id)
                },
                () => {
                    shakeSearchBtn();
                    notificatie('dot_radiowaves_left_right', 'Error', 'Unable to scan devices');
                    setScanState(false);
                });
            setScanState(true);
        }

        function searchDevices() {
            try {
                if (scanState.value == false) {
                    // If not android - start scan or check for gps enabled
                    if (!$f7.device.android) scanForDevices();
                    else ble.isLocationEnabled(
                        () => {
                            scanForDevices();
                        },
                        () => {
                            shakeSearchBtn();
                            notificatie('placemark', 'Search error', 'GPS is disabled', 'Enable location services to scan devices');
                        }
                    );
                } else {
                    setScanState(false);
                    ble.stopScan(
                        // On stop successful  
                        () => { },
                        // On stop error
                        () => {
                            shakeSearchBtn();
                            notificatie('dot_radiowaves_left_right', 'Error', 'Scan stopping error');
                        });
                }
                tapVibrate();
            } catch (error) {
                shakeSearchBtn();
                notificatie('device_laptop', 'Error', error, `It seems that this device doesn't support Bluetooth LE`);
            }
        }

        // On window loaded
        var sheet, searchBtn;
        $(document).on('page:init', '.page[data-name="settings"]', function (e) {
            sheet = $f7.sheet.create({
                el: '.search-devices-sheet',
                swipeHandler: '.can_swipe_down',
                swipeToClose: true,
                swipeToStep: true,
                closeOnEscape: true,
                closeOnBackdrop: true,
                backdrop: true,
                on: {
                    stepOpen: function (sheet) {

                    },
                    stepClose: function (sheet) {

                    },
                    close: function (sheet) {
                        try {
                            setScanState(false);
                            ble.stopScan(() => { }, () => { });
                        } catch (error) { }
                    }
                }
            });
            searchBtn = $('#searchBtn')[0];
        });

        function notificatie(icon, title, subtitle, text) {
            $f7.notification.create({
                icon: `<i class="f7-icons icon">${icon}</i>`,
                title: title,
                titleRightText: 'now',
                subtitle: subtitle,
                text: text,
                closeTimeout: 2300,
            }).open();
        }

        return $render;
    }
</script>